diff --git a/src/files.c b/src/files.c
index ec4d832a1b..3c7d60dc16 100644
--- a/src/files.c
+++ b/src/files.c
@@ -1458,7 +1458,7 @@
  * file stream opened in read-write mode.  On error, return NULL. */
 char *safe_tempfile(FILE **stream)
 {
-	const char *env_dir = getenv("TMPDIR");
+	const char *env_dir = getenv("TEMP");
 	char *tempdir = NULL, *tempfile_name = NULL;
 	char *extension;
 	int descriptor;
@@ -1472,7 +1472,7 @@
 		tempdir = check_writable_directory(P_tmpdir);
 
 	if (tempdir == NULL)
-		tempdir = copy_of("/tmp/");
+		tempdir = copy_of("~/AppData/Local/Temp/");
 
 	extension = strrchr(openfile->filename, '.');
 
diff --git a/src/utils.c b/src/utils.c
index 50ee9badba..796d5b27d5 100644
--- a/src/utils.c
+++ b/src/utils.c
@@ -35,15 +35,11 @@
 	if (homedir == NULL) {
 		const char *homenv = getenv("HOME");
 
-#ifdef HAVE_PWD_H
-		/* When $HOME is unset, or when we're root, try the database. */
-		if (homenv == NULL || geteuid() == ROOT_UID) {
-			const struct passwd *userage = getpwuid(geteuid());
+		if (homenv == NULL || *homenv == '\0')
+			homenv = getenv("USERPROFILE");
 
-			if (userage != NULL)
-				homenv = userage->pw_dir;
-		}
-#endif
+		if (homenv == NULL || *homenv == '\0')
+			homenv = getenv("ALLUSERSPROFILE");
 
 		/* Only set `homedir` if a home directory could be determined. */
 		if (homenv != NULL && *homenv != '\0')
